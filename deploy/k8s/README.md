# Kubernetes deployment

This directory uses Kustomize only.

## Choose your install

| Mode | Overlay | Use case |
| --- | --- | --- |
| Trial | `deploy/k8s/overlays/trial` | Quick evaluation, single replica, permissive defaults for lab usage |
| Prod | `deploy/k8s/overlays/prod` | Real cluster installs with stable defaults |
| OpenShift | `deploy/k8s/overlays/openshift` | OpenShift-specific route and image registry wiring |

## 5-minute trial

```bash
# Optional: prepare explicit secret values
cp deploy/k8s/overlays/trial/secrets.env.example deploy/k8s/overlays/trial/secrets.env
# edit deploy/k8s/overlays/trial/secrets.env as needed

# Optional Postgres addon for in-cluster trial DB
kubectl apply -k deploy/k8s/addons/postgres

kubectl apply -k deploy/k8s/overlays/trial
kubectl -n evidra get pods
kubectl -n evidra logs deploy/evidra-trial
```

Or use `make trial-apply`, which generates local demo token values automatically when `deploy/k8s/overlays/trial/secrets.env` is missing.

## Prod install

```bash
kubectl apply -k deploy/k8s/overlays/prod
kubectl -n evidra get pods
kubectl -n evidra logs deploy/evidra-prod
```

## Optional Postgres addon

Prod expects a database to be reachable from the cluster. If you need an in-cluster Postgres for evaluation, apply the addon:

```bash
kubectl apply -k deploy/k8s/addons/postgres
```

## Secrets and config

- Non-secret settings are in `ConfigMap/evidra-config` from base.
- Sensitive values are in `Secret/evidra-secrets` generated by each overlay.
- Source file for generation:
  - trial: `deploy/k8s/overlays/trial/secrets.env`
  - prod: `deploy/k8s/overlays/prod/secrets.env`
  - openshift: `deploy/k8s/overlays/openshift/secrets.env`
- Example templates:
  - trial: `deploy/k8s/overlays/trial/secrets.env.example`
  - prod: `deploy/k8s/overlays/prod/secrets.env.example`
  - openshift: `deploy/k8s/overlays/openshift/secrets.env.example`
- Database connection uses split secret variables:
  - `EVIDRA_DB_HOST`
  - `EVIDRA_DB_PORT`
  - `EVIDRA_DB_NAME`
  - `EVIDRA_DB_USER`
  - `EVIDRA_DB_PASSWORD`
- Auth defaults:
  - required in production: `EVIDRA_READ_TOKEN`
  - optional when Argo collector token auth is used: `EVIDRA_ARGO_API_TOKEN`
  - optional when ingest/webhook auth is enabled: `EVIDRA_INGEST_TOKEN`
- API tokens are secret-only when configured:
  - `EVIDRA_READ_TOKEN`
  - `EVIDRA_INGEST_TOKEN`
  - `EVIDRA_ARGO_API_TOKEN`

For shared or production clusters, provide `secrets.env` from a secure source or replace generator input with external secret delivery.

## Integration test mode (prod + smaller intervals)

Use `prod` overlay, then override runtime knobs for faster feedback:

```bash
kubectl apply -k deploy/k8s/overlays/prod
kubectl -n evidra patch configmap evidra-config-prod --type merge -p '{"data":{"EVIDRA_ARGO_COLLECTOR_INTERVAL":"10s"}}'
kubectl -n evidra scale deploy/evidra-prod --replicas=1
kubectl -n evidra rollout restart deploy/evidra-prod
```

## Troubleshooting

### Argo collector fails to start
- Verify `EVIDRA_ARGO_COLLECTOR_ENABLED` is intended for the overlay.
- If enabled, set valid `EVIDRA_ARGO_API_URL` and `EVIDRA_ARGO_API_TOKEN`.

### DB connection errors
- Verify `Secret/evidra-secrets*` has correct DB split variables.
- Verify DNS/service reachability to Postgres host and port.
- For trial/prod with addon, verify `Service/postgres` and `StatefulSet/postgres` are ready.

### Namespace mismatch
- All overlays target namespace `evidra`.
- Validate with:
  - `kubectl -n evidra get deploy,svc,cm,secret`
